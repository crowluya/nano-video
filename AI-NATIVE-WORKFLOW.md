# AI 原生开发工作流体系

> 基于 Tony Bai《AI 原生开发工作流实战》22讲整理
> 核心工具：Claude Code

---

## 目录

- [一、核心概念](#一核心概念)
- [二、三大支柱](#二三大支柱)
- [三、框架结构](#三框架结构)
- [四、SDD 编译三部曲](#四sdd-编译三部曲)
- [五、核心能力体系](#五核心能力体系)
- [六、安全机制](#六安全机制)
- [七、完整开发流程](#七完整开发流程)
- [八、角色迁移](#八角色迁移)

---

## 一、核心概念

### 1.1 范式演进：从 L1 到 L4

| Level | 定位 | 典型形态 | 核心特征 |
|-------|------|----------|----------|
| **L1** | AI 作为外部知识库 | 网页版 ChatGPT | 与 IDE 隔离，手动搬运上下文 |
| **L2** | AI 作为嵌入式副驾驶 | IDE 插件（Copilot） | 被动响应，视野文件级，环境绑定 |
| **L3** | AI 作为原生工作流智能体 | **Claude Code** | 主动规划，全局感知，可编排执行 |
| **L4** | AI 作为自主软件工程师 | 未来愿景 | 端到端自动化完成完整生命周期 |

**本教程定位：精通 L3，触及 L4**

### 1.2 核心哲学：规范驱动开发（SDD）

> "权力反转"——规范成为真理之源，代码降级为规范的"渲染产物"

- **传统模式**：代码 → 文档（文档易腐烂）
- **SDD 模式**：spec.md → plan.md → tasks.md → 代码（规范即真理）

### 1.3 开发者角色迁移

```
┌─────────────────────────────────────────────────────────┐
│  从"代码生产者" → "规范设计者/工作流指挥家/质量治理者"      │
├─────────────────────────────────────────────────────────┤
│  • 规范设计师：写 spec/plan/tasks                         │
│  • 工作流指挥家：设计可重复、可自动化的协作流程              │
│  • 质量治理者：高风险变更的最终审批人                      │
└─────────────────────────────────────────────────────────┘
```

---

## 二、三大支柱

```
┌─────────────────────────────────────────────────────────────┐
│           AI 原生开发工作流三大支柱                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 可执行的规范 (Specs)                                    │
│     └── spec.md → plan.md → tasks.md → 代码                   │
│                                                             │
│  2. 持久化的上下文 (Context)                                │
│     ├── CLAUDE.md      (操作手册 - 怎么做)                    │
│     ├── AGENTS.md      (跨 Agent 标准 - 可迁移)               │
│     └── constitution.md (工程宪法 - 价值观/红线)              │
│                                                             │
│  3. 可编排的行动 (Actions)                                  │
│     ├── Slash Commands  (/review, /commit...)               │
│     ├── Hooks           (PostToolUse 自动格式化)              │
│     ├── MCP             (连接 GitHub/Jira 等外部系统)         │
│     ├── Skills          (按需加载的专家知识胶囊)               │
│     └── Subagents       (独立上下文的专家分身)                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、框架结构

### 3.1 项目级框架（团队共享，入 Git）

```
.claude/
├── settings.json        # 团队基线：权限、Hooks、默认模型
├── settings.local.json  # 个人覆盖（.gitignore）
├── commands/            # Slash Commands - 团队 SOP
│   ├── review.md        # /review - 代码审查
│   ├── commit.md        # /commit - 生成提交信息
│   └── ...
├── skills/              # Agent Skills - 领域专家知识
│   └── go-expert/       # Go 语言专家技能
│       └── SKILL.md
├── agents/              # Subagents - 虚拟专家团队
│   ├── security.md      # 安全审计专家
│   ├── performance.md   # 性能优化专家
│   └── ...
├── hooks/               # 自动化脚本
│   └── post-edit-format.sh  # 编辑后自动格式化
└── templates/           # SDD 模板
    ├── plan-template.md
    └── tasks-template.md

specs/                   # 规范驱动开发目录
└── 001-feature-name/
    ├── spec.md          # 需求规范（真理之源）
    ├── plan.md          # 技术方案
    └── tasks.md         # 任务列表

CLAUDE.md                # 项目协作手册
constitution.md          # 工程宪法（NON-NEGOTIABLE）
AGENTS.md                # 跨 Agent 标准（未来兼容）
```

### 3.2 用户级框架（个人，跨项目）

```
~/.claude/
├── settings.json        # 个人默认配置
├── CLAUDE.md            # 个人偏好
├── commands/            # 个人指令集
├── skills/              # 个人技能
└── agents/              # 个人专家
```

### 3.3 配置优先级（高 → 低）

```
CLI 参数
  ↓
项目 .claude/settings.local.json
  ↓
项目 .claude/settings.json
  ↓
用户 ~/.claude/settings.json
```

---

## 四、SDD 编译三部曲

### 4.1 流程图

```
┌──────────────────────────────────────────────────────────────┐
│                    意图 → 代码的"编译"流程                    │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ① 意图定义 (WHAT/WHY)                                       │
│     spec.md: 用户故事、功能需求、验收标准、边界条件              │
│           ↓                                                  │
│  ② 技术规划 (HOW)                                             │
│     plan.md: 技术选型、架构设计、数据结构、接口设计、合宪性审查   │
│           ↓                                                  │
│  ③ 任务分解 (ACTIONS)                                         │
│     tasks.md: 原子化任务、依赖关系、TDD 顺序、并行标记           │
│           ↓                                                  │
│  ④ 自动化实现 (EXECUTE)                                       │
│     AI 按 tasks 执行 → 测试失败 → 编码 → 测试通过 → 重构         │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 spec.md 模板结构

```markdown
# Feature Name

## 用户故事
As a [角色]
I want [功能]
So that [价值]

## 功能性需求
- 需求 1
- 需求 2

## 非功能性需求
- 性能要求
- 安全要求
- 可维护性要求

## 验收标准
- [ ] 场景 1
- [ ] 场景 2

## 输出格式示例
```

### 4.3 plan.md 模板结构

```markdown
# Feature Name - 技术方案

## 技术上下文
- 语言、框架、关键依赖

## 合宪性审查
- [ ] 简单性原则
- [ ] TDD 强制
- [ ] 明确性原则
- [ ] 单一职责

## 项目结构
- 目录职责划分

## 核心数据结构
- 关键 struct 定义

## 接口设计
- 对外暴露的 Interface

## 依赖关系
- 模块间依赖图
```

### 4.4 tasks.md 特点

- **原子化**：每个任务只涉及一个主要文件
- **TDD 顺序**：先测试任务，后实现任务
- **依赖标记**：明确前置任务
- **并行标记**：`[P]` 标记可并行任务
- **阶段划分**：Foundation → Fetcher → Converter → CLI

---

## 五、核心能力体系

### 5.1 核心交互模型

| 符号 | 名称 | 作用 | 示例 |
|------|------|------|------|
| `@` | Context 注入 | AI 的眼睛 | `@file.txt` `@dir/` |
| `!` | Action 执行 | AI 的双手 | `!git status` `!go test` |
| `/` | Slash Command | 一键工作流 | `/review` `/commit` |

### 5.2 长期记忆体系

| 文件 | 作用 | 抽象层级 | 稳定性 |
|------|------|----------|--------|
| `@file` | 短期工作记忆 | 一次性上下文 | 会话级 |
| `CLAUDE.md` | 长期记忆 | 操作指南（怎么做） | 中等 |
| `constitution.md` | 长期记忆 | 价值观约束（必须/禁止） | 高 |
| `AGENTS.md` | 跨 Agent 标准 | 项目技术栈、测试命令 | 中等 |

### 5.3 能力扩展机制

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 能力扩展层级                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Slash Commands (用户驱动)                                   │
│  • 封装高频流程                                              │
│  • 确定性执行                                                │
│  • /review, /commit, /build                                  │
│                           ↓                                  │
│  Skills (模型驱动)                                           │
│  • 按需加载的专家知识                                         │
│  • 渐进式披露（3层加载）                                      │
│  • go-expert, security-audit                                 │
│                           ↓                                  │
│  Subagents (独立上下文)                                       │
│  • 专家分身，独立对话状态                                      │
│  • 专属 System Prompt + 工具权限                              │
│  • security-reviewer, performance-optimizer                  │
│                           ↓                                  │
│  Hooks (事件驱动)                                            │
│  • 生命周期节点自动触发                                        │
│  • PreToolUse / PostToolUse / Notification                   │
│  • 自动格式化、分支保护、系统通知                              │
│                           ↓                                  │
│  MCP (外部连接)                                               │
│  • 连接 GitHub/Jira/设计系统                                  │
│  • Tools / Resources / Prompts                               │
│  • 认证解耦，服务发现                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 Slash Command 模板

```markdown
---
description: 审查代码并给出反馈
argument-hint: [path]
model: opus
allowed-tools:
  - Read
  - Grep
  - Bash(go vet:*)
---

你现在是项目首席架构师，请审查 @$1 中的代码。

**审查准则：**
1. 简单性原则
2. 明确性原则（错误处理）
3. 单一职责原则

**输出格式：**
- 总体评价
- 优点
- 待改进项（按优先级）
```

### 5.5 Headless 模式（可编程接口）

```bash
# 基础用法
claude -p "你的 prompt"

# 管道输入
cat log.txt | claude -p "分析这份日志"

# JSON 输出
claude -p "..." --output-format json | jq '.result'

# 集成到脚本
#!/bin/bash
RESULT=$(cat diff.txt | claude -p "生成 commit message" --output-format json)
echo "$RESULT" | jq -r '.result' | git commit -F -
```

---

## 六、安全机制

### 6.1 三层安全防护

```
┌─────────────────────────────────────────────────────────────┐
│                        安全防护体系                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Layer 1: Permissions（应用层立法）                           │
│  • deny: 敏感文件、危险命令                                    │
│  • allow: 只读操作、测试、格式化                               │
│  • ask: 写文件、git 操作                                      │
│                           ↓                                  │
│  Layer 2: Sandbox（OS 层隔离）                               │
│  • 文件系统：写操作限制在 CWD                                  │
│  • 网络：默认拒绝，白名单通行                                  │
│                           ↓                                  │
│  Layer 3: Checkpointing（时光回溯）                           │
│  • /rewind: 回退代码/对话                                     │
│  • 降低"反悔成本"，鼓励探索                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 Permissions 配置示例

```json
{
  "permissions": {
    "defaultMode": "plan",
    "allow": [
      "Read(*.go)",
      "Read(go.mod)",
      "Grep",
      "Glob",
      "Bash(go:test:*)",
      "Bash(gofmt:*)"
    ],
    "ask": [
      "Write",
      "Edit",
      "Bash(go:get:*)",
      "Bash(git:commit:*)"
    ],
    "deny": [
      "Read(./.env*)",
      "Bash(rm:*)",
      "Bash(git:push:--force)"
    ]
  }
}
```

### 6.3 Checkpointing 三种回退模式

| 模式 | 作用 | 适用场景 |
|------|------|----------|
| Rewind code | 只回退代码 | 讨论思路对，实现不满意 |
| Rewind conversation | 只回退对话 | 代码满意，想换种问法 |
| Rewind both | 全部回退 | 整段探索都走偏了 |

---

## 七、完整开发流程

### 7.1 从想法到交付的全流程

```
┌──────────────────────────────────────────────────────────────────┐
│                    AI 原生开发完整工作流                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ① 需求澄清 (17讲)                                               │
│      AI 扮演产品经理，通过提问澄清需求                            │
│      ↓                                                          │
│  ② 生成 spec.md (17讲)                                           │
│      用户故事 + 功能需求 + 验收标准                               │
│      ↓                                                          │
│  ③ 生成 plan.md (18讲)                                           │
│      技术选型 + 架构设计 + 合宪性审查                             │
│      ↓                                                          │
│  ④ 生成 tasks.md (18讲)                                          │
│      原子化任务 + TDD 顺序 + 依赖关系                             │
│      ↓                                                          │
│  ⑤ TDD 编码 (19讲)                                               │
│      RED: 写失败测试                                             │
│      GREEN: 写最少实现                                           │
│      REFACTOR: 重构优化                                         │
│      ↓                                                          │
│  ⑥ AI 交叉审查 (20讲)                                            │
│      调用 /review 指令，对照宪法审查                              │
│      ↓                                                          │
│  ⑦ 生成 Commit + PR (20讲)                                      │
│      !git diff → 生成符合规范的提交信息                           │
│      ↓                                                          │
│  ⑧ 构建 & 交付 (21讲)                                            │
│      Makefile + Dockerfile + CI/CD                              │
│      ↓                                                          │
│  ⑨ 维护 & 重构 (22讲)                                            │
│      Headless 日志分析 + Checkpointing 安全重构                  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 7.2 Git 集成工作流

```bash
# 1. AI 审查代码
/review internal/

# 2. 查看变更
!git diff

# 3. AI 生成提交信息
/commit

# 4. 提交（AI 生成后手动批准）
!git add .
!git commit -m "feat(...): ..."

# 5. Push
!git push
```

---

## 八、角色迁移

### 8.1 传统 vs AI 原生

| 维度 | 传统开发 | AI 原生开发 |
|------|----------|-------------|
| **核心产出** | 代码 | 规范（spec/plan/tasks） |
| **编码方式** | 手写每一行 | 指挥 AI 生成，审查验收 |
| **质量保障** | 人工 Code Review | AI 交叉审查 + 人工终审 |
| **文档** | 独立维护，易腐烂 | spec 驱动，代码即文档 |
| **重复工作** | 手动执行 | Commands + Hooks 自动化 |

### 8.2 新时代工程师能力栈

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 原生工程师能力栈                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  顶层：架构思维、系统设计、领域知识                           │
│   ↑                        (人不可替代)                      │
│                                                             │
│  中层：规范设计、工作流编排、质量治理                         │
│   ↑                    (人主导，AI 辅助)                     │
│                                                             │
│  底层：编码实现、测试编写、文档生成                           │
│   ↑                    (AI 主力，人监督)                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 附录：快速参考

### 核心 CLI 命令

```bash
# 会话管理
claude                  # 启动交互式会话
claude -p "..."         # Headless 模式
/memory                 # 查看已加载上下文
/permissions            # 查看权限配置
/status                 # 查看会话状态

# 时光回溯
/rewind                 # 或双击 Esc
Esc Esc                 # 快捷键

# 模板生成（如果配置）
/init                   # 初始化 CLAUDE.md
/specify                # 生成 spec.md
/plan                   # 生成 plan.md
/tasks                  # 生成 tasks.md
```

### 环境变量（引擎切换）

```bash
# 接入国产大模型
export ANTHROPIC_BASE_URL="https://api.example.com/v1"
export ANTHROPIC_AUTH_TOKEN="your-api-key"
```

### 推荐阅读顺序

1. **初学者**：00 → 04 → 05 → 06 → 08 → 16
2. **进阶者**：09 → 10 → 11 → 12 → 13 → 14 → 15
3. **实战者**：16 → 17 → 18 → 19 → 20 → 21 → 22

---

*文档生成时间：2025-01-13*
*基于：Tony Bai《AI 原生开发工作流实战》22讲*
