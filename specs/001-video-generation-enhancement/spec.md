# 视频生成功能增强 - 需求规范

> 本文档是功能的唯一真理来源，所有技术方案和实现都应基于此文档

---

## 元信息

| 字段 | 值 |
|------|-----|
| **创建日期** | 2025-01-13 |
| **负责人** | AI Assistant |
| **优先级** | P1 |
| **状态** | 示例 |
| **基于规范** | @constitution.md |

---

## 用户故事

**作为一名** 内容创作者
**我想要** 使用 AI 生成高质量的视频内容
**以便于** 快速制作营销视频、社交媒体内容或创意短片

### 背景说明

当前项目已集成 kie.ai 的视频生成 API（Sora 2、Veo 3.1），但用户体验和功能完整性还有提升空间。本次增强旨在优化视频生成流程，提供更好的用户体验和更丰富的功能。

---

## 功能性需求

### 核心功能

1. **文生视频 (Text-to-Video)**
   - 描述：用户输入文字描述，AI 生成对应视频
   - 输入：文字 prompt（最长 500 字符）、模型选择、视频参数
   - 输出：生成的视频文件 URL

2. **图生视频 (Image-to-Video)**
   - 描述：用户上传图片作为首帧，AI 生成动态视频
   - 输入：图片文件、文字描述、模型选择
   - 输出：生成的视频文件 URL

3. **生成进度追踪**
   - 描述：实时显示视频生成进度
   - 输入：任务 ID
   - 输出：进度百分比、预计剩余时间、状态信息

4. **历史记录管理**
   - 描述：查看和管理已生成的视频
   - 输入：用户 ID、分页参数
   - 输出：视频列表（含缩略图、标题、创建时间）

5. **视频保存到 R2**
   - 描述：将 kie.ai 临时存储的视频永久保存到 R2
   - 输入：视频 URL、用户 ID
   - 输出：R2 永久 URL

### 边界条件

**必须支持**：
- [x] Sora 2 模型（文生视频、图生视频）
- [x] Veo 3.1 模型（文生视频、首帧/首尾帧模式）
- [x] 视频分辨率：720p、1080p
- [x] 视频时长：5s、10s、15s（根据模型限制）
- [x] 积分扣除和余额检查

**不支持**（明确排除）：
- [ ] 视频编辑功能（由 Remotion 模块处理）
- [ ] 批量生成（V2 考虑）
- [ ] 自定义模型训练

---

## 非功能性需求

### 性能要求
- 页面加载时间 < 2 秒
- 任务提交响应时间 < 1 秒
- 进度轮询间隔：5 秒

### 安全要求
- [x] 用户必须登录才能生成视频
- [x] 积分余额检查在服务端执行
- [x] 上传图片大小限制 < 10MB
- [x] 上传图片格式限制：jpg, png, webp

### 国际化要求
- [x] 支持 en/zh/ja 三语言
- [x] 所有用户界面文本可翻译
- [x] 错误消息本地化

---

## 验收标准

### 场景 1：文生视频成功
- [x] 给定 用户已登录且积分充足
- [x] 当 用户输入 prompt 并点击生成
- [x] 那么 显示生成进度，完成后显示视频预览

### 场景 2：积分不足
- [x] 给定 用户积分余额不足
- [x] 当 用户尝试生成视频
- [x] 那么 显示积分不足提示，引导充值

### 场景 3：图生视频
- [x] 给定 用户上传了有效图片
- [x] 当 用户输入描述并点击生成
- [x] 那么 以图片为首帧生成视频

### 场景 4：保存到永久存储
- [x] 给定 视频生成完成
- [x] 当 用户点击"保存"按钮
- [x] 那么 视频从 kie.ai 临时存储转存到 R2

### 场景 5：查看历史记录
- [x] 给定 用户有生成历史
- [x] 当 用户访问历史页面
- [x] 那么 显示分页的视频列表，支持预览和删除

---

## 约束条件

### 技术约束
- 必须使用 Next.js 16 (App Router)
- 必须使用 TypeScript
- 必须遵循 @constitution.md
- 视频生成使用 kie.ai API
- 永久存储使用 Cloudflare R2

### 业务约束
- 积分消耗：Sora 2 = 100 积分/个，Veo 3.1 = 80- kie.ai 生成文件保留 2 个月
- 用户需主动保存到 R2 才能永久保留

### 依赖约束
- 依赖 `lib/kie/client.ts` - kie.ai 客户端
- 依赖 `lib/cloudflare/r2.ts` - R2 存储
- 依赖 `lib/payments/credit-manager.ts` - 积分管理

---

## 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| kie.ai API 不稳定 | 高 | 中 | 添加重试机制，友好错误提示 |
| 视频生成超时 | 中 | 中 | 设置合理超时，支持后台继续 |
| 积分扣除失败 | 高 | 低 | 事务处理，失败回滚 |

---

## 附录

### 参考资料
- [kie.ai API 文档](https://kie.ai/docs)
- [Cloudflare R2 文档](https://developers.cloudflare.com/r2/)
- `.cursor/rules/06-ai-integration.mdc`
- `.cursor/rules/10-cloudflare-r2.mdc`

### 术语表
| 术语 | 定义 |
|------|------|
| Text-to-Video | 文字生成视频 |
| Image-to-Video | 图片生成视频 |
| kie.ai | AI 内容生成服务提供商 |

---

*变更历史*
| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 1.0 | 2025-01-13 | 初始版本（示例） | AI Assistant |
